name: Auto Refresh Dashboard

on:
  schedule:
    # Every 5 minutes during market hours (Mon–Fri)
    # UTC 03:45–10:00 ≈ IST 09:15–15:30
    - cron: "*/5 3-10 * * 1-5"
  workflow_dispatch:

jobs:
  refresh:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # Decode BASE64 secret -> single-line JSON env var (same name)
      - name: Decode Google service account JSON
        env:
          GOOGLE_SERVICE_ACCOUNT_JSON: ${{ secrets.GOOGLE_SERVICE_ACCOUNT_JSON }}
        run: |
          echo "$GOOGLE_SERVICE_ACCOUNT_JSON" | base64 -d > /tmp/gcp_sa.json
          python -c "import json; print('GOOGLE_SERVICE_ACCOUNT_JSON=' + json.dumps(json.load(open('/tmp/gcp_sa.json'))))" >> $GITHUB_ENV

      # Optional: sanity (remove after first success)
      - name: Debug decoded JSON length
        run: |
          echo "Decoded JSON length: ${#GOOGLE_SERVICE_ACCOUNT_JSON}"

      - name: Run TMV updater (writes LiveScores)
        env:
          GOOGLE_SERVICE_ACCOUNT_JSON: ${{ env.GOOGLE_SERVICE_ACCOUNT_JSON }}
          BACKGROUND_SHEET_KEY: ${{ secrets.BACKGROUND_SHEET_KEY }}
          WATCHLIST_WORKSHEET: "Watchlist"
          LIVESCORE_WORKSHEET: "LiveScores"
          ZERODHA_TOKEN_SHEET_KEY: ${{ secrets.ZERODHA_TOKEN_SHEET_KEY }}
          ZERODHA_TOKEN_WORKSHEET: "Sheet1"
        run: |
          python tmv_updater.py

      - name: Post-run sanity log
        if: always()
        run: |
          echo "TMV updater finished at UTC: $(date -u)"
